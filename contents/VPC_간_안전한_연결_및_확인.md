## VPC와 VPC를 안전하게 연결하고 연결후 동작을 확인하는 방법

### VPC(Virtual Private Cloud)란?

VPC(Virtual Private Cloud)는 AWS에서 제공하는 가상 네트워크 서비스입니다. VPC를 사용하면 AWS 클라우드 내에서 논리적으로 격리된 가상 네트워크를 프로비저닝할 수 있습니다. VPC는 IP 주소 범위, 서브넷, 라우팅 테이블, 네트워크 게이트웨이 등을 포함하여 고객이 완전히 제어할 수 있는 가상 네트워크 환경을 제공합니다.

VPC를 사용하는 주요 이유는 클라우드 내 리소스를 안전하게 격리하고 네트워크 액세스를 제어할 수 있기 때문입니다. VPC를 통해 AWS 리소스에 대한 인바운드 및 아웃바운드 트래픽을 모두 제어할 수 있으며, 인터넷 게이트웨이, NAT 게이트웨이, VPN 연결 등을 구성하여 외부 네트워크와의 연결을 관리할 수 있습니다. 또한 VPC 내에서 여러 계층의 웹 애플리케이션을 배포하고 프라이빗 IP 주소 공간을 사용하여 보안을 강화할 수 있습니다.

VPC의 주요 구성 요소로는 서브넷, 라우팅 테이블, 인터넷 게이트웨이, NAT 게이트웨이, VPN 연결, 네트워크 ACL, 보안 그룹 등이 있습니다. 이러한 구성 요소를 통해 VPC 내부의 네트워크 토폴로지와 보안 정책을 세밀하게 제어할 수 있습니다.

VPC를 사용하면 조직의 요구사항에 맞게 네트워크 토폴로지를 구성하고 리소스를 안전하게 격리할 수 있습니다. 또한 VPC 내에서 여러 가용 영역에 걸쳐 리소스를 배포하여 가용성을 높일 수 있으며, 필요에 따라 VPC를 확장하거나 다른 VPC와 연결할 수 있습니다. VPC는 AWS 클라우드 내에서 안전하고 확장 가능한 네트워크 환경을 구축하는 데 필수적인 서비스입니다.


### VPC 내부 네트워크 구성

VPC(Virtual Private Cloud)를 생성한 후에는 VPC 내부에서 네트워크를 적절히 구성해야 합니다. 이를 위해서는 서브넷, 라우팅 테이블, 인터넷 게이트웨이, NAT 게이트웨이 등의 구성 요소를 이해하고 올바르게 설정해야 합니다.

#### 서브넷 구성
서브넷은 VPC 내부의 IP 주소 범위를 더 작은 세그먼트로 나누어 네트워크를 논리적으로 분할하고 리소스를 격리합니다. 일반적으로 퍼블릭 서브넷과 프라이빗 서브넷으로 나누어 구성합니다.

- 퍼블릭 서브넷: 인터넷 게이트웨이를 통해 인터넷에 직접 액세스할 수 있는 서브넷입니다. 웹 서버, 로드 밸런서 등의 인터넷 연결이 필요한 리소스를 배포합니다.
- 프라이빗 서브넷: 인터넷에 직접 액세스할 수 없는 서브넷입니다. 데이터베이스, 애플리케이션 서버 등의 내부 리소스를 배포하며, NAT 게이트웨이를 통해 아웃바운드 인터넷 액세스가 가능합니다.

#### 라우팅 테이블 구성
라우팅 테이블은 VPC 내부 및 외부로 향하는 네트워크 트래픽 흐름을 제어하는 규칙 집합입니다. 각 서브넷은 라우팅 테이블과 연결되어 있으며, 라우팅 테이블의 규칙에 따라 트래픽이 전달됩니다. 라우팅 테이블에는 대상 CIDR 블록과 대상에 도달하기 위한 게이트웨이(인터넷 게이트웨이, NAT 게이트웨이 등)가 정의되어 있습니다.

- 퍼블릭 서브넷 라우팅 테이블: 인터넷 게이트웨이로 향하는 경로를 포함하여 인터넷 액세스를 허용합니다.
- 프라이빗 서브넷 라우팅 테이블: NAT 게이트웨이로 향하는 경로를 포함하여 아웃바운드 인터넷 액세스만 허용합니다.

#### 인터넷 게이트웨이 및 NAT 게이트웨이 구성
인터넷 게이트웨이는 VPC와 인터넷 간의 통신을 가능하게 하는 수평 확장 가능한 리소스입니다. 인터넷 게이트웨이를 VPC에 연결하고 퍼블릭 서브넷 라우팅 테이블에 적절한 경로를 추가하면, 퍼블릭 서브넷의 리소스가 인터넷에 액세스할 수 있습니다.

NAT 게이트웨이는 프라이빗 서브넷에 배포된 리소스가 인터넷에 아웃바운드 연결을 설정할 수 있도록 해주는 AWS 관리형 서비스입니다. NAT 게이트웨이를 프라이빗 서브넷 라우팅 테이블에 연결하면, 프라이빗 서브넷의 리소스가 인터넷에 액세스할 수 있지만 인터넷에서는 해당 리소스에 직접 액세스할 수 없게 됩니다.

이러한 VPC 내부 네트워크 구성 요소들을 적절히 조합하여 보안, 확장성, 가용성 등의 요구 사항을 충족하는 네트워크 아키텍처를 구축할 수 있습니다. 예를 들어, 웹 서버는 퍼블릭 서브넷에, 데이터베이스는 프라이빗 서브넷에 배포하는 것이 일반적인 패턴입니다. 또한 AWS PrivateLink를 사용하여 VPC 내부에서 AWS 서비스에 안전하게 액세스할 수 있습니다.


### 두 개 이상의 VPC 연결 방법

AWS에서는 여러 VPC를 연결하기 위해 다양한 옵션을 제공합니다. 적절한 옵션을 선택하려면 조직의 요구사항, 보안 요구사항, 비용, 복잡성 등을 고려해야 합니다.

#### VPC 피어링(VPC Peering)
VPC 피어링은 동일한 AWS 리전 내에서 두 개의 VPC를 직접 연결하는 방법입니다. 예를 들어 개발 VPC와 프로덕션 VPC를 피어링하여 리소스 간 통신이 가능합니다. 피어링된 VPC는 마치 동일 네트워크에 있는 것처럼 작동하며, 데이터 전송 비용이 발생하지 않습니다. 장점은 간단하고 저렴하며 높은 대역폭과 낮은 지연시간을 제공한다는 것입니다. 단점은 동일 리전 내에서만 작동하고 전이적 피어링이 지원되지 않는다는 점입니다.

#### VPN 연결(VPN Connection)
VPN 연결은 AWS VPC와 온프레미스 데이터센터 또는 다른 클라우드 제공업체의 VPC 간에 암호화된 연결을 설정합니다. 예를 들어 AWS VPC와 회사 내부 네트워크를 VPN으로 연결할 수 있습니다. VPN 연결의 장점은 온프레미스와 AWS 간 안전한 연결을 제공하고 다른 클라우드와도 연결 가능하다는 것입니다. 단점은 설정이 복잡하고 대역폭과 가용성이 제한적일 수 있습니다.

#### Transit Gateway
Transit Gateway는 여러 VPC, VPN 연결, Direct Connect 게이트웨이를 중앙 집중식으로 연결하는 관리형 서비스입니다. 예를 들어 여러 VPC와 온프레미스 데이터센터를 Transit Gateway로 연결하면 복잡한 네트워크 토폴로지를 단순화할 수 있습니다. 장점은 중앙 집중식 연결 관리, 확장성, 높은 가용성과 대역폭, 전이적 라우팅 지원 등입니다. 단점은 추가 비용 발생과 복잡한 네트워크에서 설정이 어려울 수 있다는 점입니다.

일반적으로 동일 리전 내 VPC 간에는 VPC 피어링이 가장 간단하고 효율적입니다. 온프레미스 네트워크나 다른 클라우드와 연결할 때는 VPN 연결을 사용합니다. 대규모 복잡한 네트워크 토폴로지에서는 Transit Gateway를 활용하여 중앙 집중식으로 연결을 관리할 수 있습니다.


### VPC 연결 후 트래픽 흐름과 보안

VPC를 연결한 후에는 트래픽 흐름과 보안에 대해 고려해야 합니다. 연결된 VPC 간에는 트래픽이 자유롭게 이동할 수 있으므로, 적절한 보안 메커니즘을 구현하여 리소스를 보호해야 합니다.

#### 보안 그룹(Security Group)

보안 그룹은 VPC 내부의 인스턴스 수준에서 인바운드 및 아웃바운드 트래픽을 제어하는 가상 방화벽 역할을 합니다. 보안 그룹은 인스턴스에 연결되며, 소스 IP 주소, 프로토콜, 포트 번호 등을 기반으로 트래픽을 허용하거나 거부할 수 있습니다. 보안 그룹은 상태 저장(stateful) 방식으로 작동하므로, 아웃바운드 트래픽에 대한 응답 트래픽은 자동으로 허용됩니다.

예를 들어, VPC A의 웹 서버 인스턴스에서 VPC B의 애플리케이션 서버로 통신하려면 웹 서버 인스턴스의 보안 그룹에서 VPC B의 애플리케이션 서버 IP 범위를 허용하도록 인바운드 규칙을 추가해야 합니다.

#### 네트워크 ACL(Network ACL)

네트워크 ACL은 VPC 수준에서 서브넷 간 트래픽을 제어하는 방화벽 역할을 합니다. 네트워크 ACL은 규칙 번호, 소스 IP 주소, 대상 IP 주소, 프로토콜, 포트 번호 등을 기반으로 트래픽을 허용하거나 거부할 수 있습니다. 네트워크 ACL은 상태 비저장(stateless) 방식으로 작동하므로, 아웃바운드 트래픽에 대한 응답 트래픽을 명시적으로 허용해야 합니다.

예를 들어, VPC A의 웹 서버 서브넷에서 VPC B의 애플리케이션 서버로 통신하려면 웹 서버 서브넷의 네트워크 ACL에서 VPC B의 애플리케이션 서버 IP 범위로부터의 인바운드 트래픽을 허용하도록 규칙을 추가해야 합니다. 또한 아웃바운드 트래픽에 대한 응답 트래픽도 허용해야 합니다.

#### VPC 피어링을 통한 통신

VPC 피어링을 사용하면 피어링된 VPC 간에 프라이빗 IP 주소를 사용하여 통신할 수 있습니다. 피어링된 VPC 간에는 라우팅 테이블에 경로를 추가하여 트래픽 흐름을 제어할 수 있습니다. 또한 보안 그룹과 네트워크 ACL 규칙을 적절히 구성하여 리소스를 보호해야 합니다.

예를 들어, VPC A와 VPC B를 피어링한 후, VPC A의 웹 서버에서 VPC B의 데이터베이스에 액세스하려면 웹 서버 인스턴스의 보안 그룹에서 데이터베이스 IP 주소를 허용하고, 웹 서버 서브넷의 네트워크 ACL에서도 데이터베이스 IP 주소로부터의 인바운드 트래픽을 허용해야 합니다. 또한 라우팅 테이블에 VPC B의 CIDR 블록으로 향하는 경로를 추가해야 합니다.

VPC 연결 후에는 트래픽 흐름과 보안 메커니즘을 면밀히 검토하고 구성해야 합니다. 보안 그룹과 네트워크 ACL을 활용하여 리소스를 보호하고, 필요한 경우에만 트래픽을 허용하는 것이 중요합니다. 또한 연결된 VPC 간에 리소스를 공유하고 통신할 때는 적절한 보안 조치를 취해야 합니다.


### VPC 연결 모니터링 및 문제 해결

VPC를 연결한 후에는 네트워크 트래픽과 리소스 상태를 지속적으로 모니터링하고 문제가 발생했을 때 신속하게 대응할 수 있어야 합니다. AWS에서는 VPC 흐름 로그, 트래픽 미러링 등의 도구를 제공하여 VPC 연결 모니터링 및 문제 해결을 지원합니다.

#### VPC 흐름 로그 설정 및 활용

1. Amazon VPC 콘솔에서 VPC 흐름 로그를 생성합니다. 흐름 로그를 캡처할 리소스(VPC, 서브넷, 네트워크 인터페이스)와 로그 데이터를 저장할 대상(Amazon CloudWatch Logs 또는 Amazon S3)을 선택합니다.

2. 필요에 따라 흐름 로그 레코드 필터를 설정하여 특정 IP 주소 범위, 프로토콜, 포트 번호 등의 트래픽만 캡처할 수 있습니다.

3. 생성된 VPC 흐름 로그에서 네트워크 트래픽 패턴을 분석하고 보안 이벤트를 탐지합니다. 예를 들어 특정 IP 주소 범위 간의 트래픽 볼륨을 확인하거나 예상치 못한 트래픽 패턴을 탐지할 수 있습니다.

4. 보안 그룹 및 네트워크 ACL 규칙의 효과를 검증하고 문제를 해결하는 데에도 VPC 흐름 로그를 활용할 수 있습니다.

#### 트래픽 미러링 설정 및 활용

1. Amazon VPC 콘솔에서 트래픽 미러 세션을 생성합니다. 미러링할 소스(네트워크 인터페이스, 서브넷)와 대상(네트워크 로드 밸런서)을 지정합니다.

2. 트래픽 미러 필터를 사용하여 미러링할 트래픽 유형(프로토콜, IP 주소 범위 등)을 선택합니다.

3. 캡처된 패킷 데이터는 Amazon Athena, Amazon Kinesis Data Firehose 또는 타사 도구를 사용하여 분석합니다.

4. 패킷 데이터 분석을 통해 네트워크 성능 문제, 보안 위협, 애플리케이션 동작 등을 심층적으로 파악하고 문제를 해결할 수 있습니다.

VPC 연결 후에는 VPC 흐름 로그와 트래픽 미러링을 적절히 구성하고 로그 데이터를 분석하여 네트워크 트래픽을 모니터링하고 문제를 해결할 수 있습니다. 이를 통해 VPC 연결의 상태를 파악하고 잠재적인 문제를 조기에 탐지할 수 있으며, 문제 발생 시 신속한 대응과 근본 원인 분석이 가능해집니다.


